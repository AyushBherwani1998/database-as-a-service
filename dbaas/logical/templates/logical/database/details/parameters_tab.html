{% extends "logical/database/details/base.html" %}
{% load admin_static %}

{% block tab %}
<fieldset class="module aligned ">
  <div class="panel-heading">
    <h3 class="panel-title">Custom Parameters</h3>
  </div>

  <div class="panel-body">

    <table id="table-parameters" class="table table-striped" data-database-id="{{database.pk}}" >
      <thead>
        <tr>
          <th>Parameter</th>
          <th class="default_value_header">DBaaS default value</th>
          <th class="custom_value_header">Custom value</th>
          {% if is_dba %}
            {% if form_status  == EDITABLE or form_status == TASK_ERROR %}
              <th class="new_value_header">New custom value</th>
            {% endif %}
          {% endif %}
          <th class="type_header">Type</th>
          <th class="allowed_values">Allowed values</th>
          <th>Description</th>
        </tr>
      <tbody>
        {% for parameter in form_database_parameters %}
          <tr>
            <td>
              {{parameter.name}}
              {% if not parameter.dynamic %}
                *
              {% endif %}
            </td>
            <td>
              {{parameter.dbaas_default_value}}
              <input type="hidden" name="dbaas_default_value_{{parameter.id}}" id="dbaas_default_value_{{parameter.id}}" value="{{parameter.dbaas_default_value}}">
            </td>
            <td>
             {{parameter.current_value}}
             {% if not parameter.applied_on_database %}
              (it was not applied on database yet)
             {% endif %}
            </td>
            {% if is_dba %}
              {% if form_status  == EDITABLE or form_status == TASK_ERROR %}
                <td>
                  <p class="error_message">Invalid value.</p>
                  {% if parameter.parameter_type == "boolean" %}
                    {% if parameter.engine_type == "mysql" %}
                        <select class="new_custom_value_input" id="new_value_{{parameter.id}}"
                         name="new_value_{{parameter.id}}" value="{{parameter.new_value}}"
                         {% if not parameter.editable_parameter %} disabled {% endif %}>
                            <option value=""></option>
                            <option value="ON">ON</option>
                            <option value="OFF">OFF</option>
                        </select>
                    {% endif %}
                    {% if parameter.engine_type == "redis" %}
                        <select class="new_custom_value_input" id="new_value_{{parameter.id}}"
                         name="new_value_{{parameter.id}}" value="{{parameter.new_value}}"
                         {% if not parameter.editable_parameter %} disabled {% endif %}>
                            <option value=""></option>
                            <option value="yes">yes</option>
                            <option value="no">no</option>
                        </select>
                    {% endif %}
                    {% if parameter.engine_type == "mongodb" %}
                        <select class="new_custom_value_input" id="new_value_{{parameter.id}}"
                         name="new_value_{{parameter.id}}" value="{{parameter.new_value}}"
                         {% if not parameter.editable_parameter %} disabled {% endif %}>
                            <option value=""></option>
                            <option value="True">True</option>
                            <option value="False">False</option>
                        </select>
                    {% endif %}
                  {% else %}
                    <input type="text" class="new_custom_value_input" placeholder="type new value"
                     maxlength="200" id="new_value_{{parameter.id}}"
                     name="new_value_{{parameter.id}}" value="{{parameter.new_value}}"
                     {% if not parameter.editable_parameter %} disabled {% endif %}
                    >
                  {% endif %}
                  <label class="checkbox">
                    <input class="checkbox_action" id="checkbox_reset_{{parameter.id}}" name="checkbox_reset_{{parameter.id}}"
                      type="checkbox"
                       onclick=
                       {% if not parameter.editable_parameter %}
                       "return false;"
                       {% else %}
                       "reset_default(this, {{parameter.id}});"
                       {% endif %}
                       {% if not parameter.editable_parameter %} disabled {% endif %}
                    />
                    <input type="hidden" name="dynamic_{{parameter.id}}" id="dynamic_{{parameter.id}}" value="{{parameter.dynamic}}">
                    <span><label class="vCheckboxLabel" for="checkbox_reset_{{parameter.id}}">Reset to default value</label></span>
                  </label>
                </td>
                
              {% endif %}
            {% endif %}
            <td class="type_cell">
             {{parameter.parameter_type}}
             {% if not parameter.applied_on_database %}
              (it was not applied on database yet)
             {% endif %}
             <input name="parameter_type_hidden" type="hidden" class="type_meta" value="{{parameter.parameter_type}}">
            </td>
            <td class="allowed_values_cell">
             {{parameter.allowed_values}}
             {% if not parameter.applied_on_database %}
              (it was not applied on database yet)
             {% endif %}
             <input name="allowed_values_hidden" type="hidden" class="allowed_values_meta" value="{{parameter.allowed_values}}">
            </td>
            <td class="parameter_description_cell">
             {{parameter.description}}
             {% if not parameter.applied_on_database %}
              (it was not applied on database yet)
             {% endif %}
            </td>


          </tr>
        {% endfor %}
      </tbody>
      </thead>
    </table>

  </div>
</fieldset>

<!-- Modal -->
<div class="modal fade" id="change_parameter_modal" tabindex="-1" role="dialog" aria-labelledby="change parameter" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <!-- Modal Header -->
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">
          <span aria-hidden="true">&times;</span>
        </button>
        <h4 class="modal-title">Change Parameter</h4>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">
        <div role="form">
          <div class="form-group">
            <label>
              {% if database.infra.plan.is_ha %}
                Change parameter process will switch hosts, and <b class="bold_red">it may cause connections errors</b> during the process.
              {% else %}
                Change parameter process <b class="bold_red">will stop the database</b> and, consequently, it will be <b class="bold_red">unavailable</b> until the the end of the process.
              {% endif %}

              <br><br>
              Please type <u><b>yes</b></u> to confirm:
            </label>
            <input autocomplete="off" class="vTextField" id="id_change_parameter_yes" maxlength="300" name="change_parameter_yes" type="text"/>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
        <input type="submit" value="Apply" name="change_parameter_btn_modal" id="id_change_parameter_btn_modal"/>
      </div>
    </div>
  </div>
</div>

{% include "admin/confirmation_modal.html" with modal_id="save_changes" confirmation_message="Do you want to save the changes made to the parameters?" box_title="Saving changes" button_type="submit" button_value="Apply" button_name="change_parameter_btn_modal" %}

{% include "admin/confirmation_modal.html" with modal_id="retry_save_changes" confirmation_message="Do you want to try saving the changes made to the parameters again?" box_title="Saving changes" button_type="submit" button_value="Retry Change Parameters" button_name="retry_update_parameters" %}

{% endblock %}

{% block database_button_save %}
  {% if is_dba %}

    <div class="form-actions navbar navbar-fixed-bottom">
        <div class="container">
          <div class="pull-left save-options-box">


            {% if static_parameter %}
              <p>* Static parameter, it will be necessary restart the database if changed.</p>
            {% endif %}

            {% if form_status  == PROTECTED or form_status == TASK_SUCCESS %}
            <input type="submit" value="Edit" name="edit_parameters" id="id_edit_parameters_btn" class="btn btn-primary"/>
          {% elif  form_status  == EDITABLE %}
            <input type="submit" value="Save" name="save_parameters" class="btn btn-primary save_button"
              id="save_parameters"
            />
            <input type="submit" value="Cancel" name="cancel_edit_parameters"
              id="id_cancel_edit_parameters_btn" class="btn btn-primary"
            />

          {% elif  form_status  == TASK_ERROR %}
            <input type="submit" value="Retry Change Parameters"
              name="retry_button" id="id_retry_save_parameters" class="btn btn-warning save_button"
            />
            <p><a href="{% url 'admin:maintenance_databasechangeparameter_change' last_change_parameters.id %}" target='_blank'>Last change parameters</a> has an <b>error</b>, please check the <a href="{% url 'admin:notification_taskhistory_change' last_change_parameters.task.id %}" target='_blank'>task</a> and retry the database change parameters clicking in button above</p>
          {% endif %}

        </div>
      </div>
    </div>
  {% endif %}
{% endblock %}

{% block js_footer %}
{{ block.super }}

<script type="text/javascript">

  function reset_default(checkbox_control, id)
  {
    if (checkbox_control.checked)
    {
      var dbaas_default_value = document.getElementById("dbaas_default_value_"+id);
      var new_value = document.getElementById("new_value_"+id);
      new_value.disabled = true;
      new_value.value = dbaas_default_value.value;
    }
    else
    {
      var new_value = document.getElementById("new_value_"+id);
      new_value.disabled = false;
      new_value.value = "";
    }
  }

  var Validator = {};
  (function(){

    var validate_all = function(button_id, event)
    {
      var inputs = document.getElementsByClassName("new_custom_value_input");
      var new_value;
      var values_are_valid = true;
      for (var i = 0; i < inputs.length; i++){
        if( !validateSingleInput( $(inputs[i]) ) )
          values_are_valid = false;
      }
      if(values_are_valid){
        set_modal(button_id)
      }
      else{
        event.preventDefault();
        event.stopPropagation();
      }
    }

    var validateSingleInput = function(input_element){
      var current_input = input_element;
      var error_message = current_input.parents("tr").find(".error_message");
      error_message.hide();
      current_input.css('border', '1px solid #ccc');

      var current_type = current_input.parents("tr").find(".type_meta").val().trim();
      var current_allowed_values = current_input.parents("tr").find(".allowed_values_meta").val().trim();
      if(!validate_new_value(current_input.val(), current_type, current_allowed_values)){
        current_input.css('border', '1px solid #ff0000');
        error_message.show();
        return false;
      }

      return true;
    }

    var validate_new_value = function(value, acceptable_type, allowed_values){
      console.log(acceptable_type)
      if(value==''){
        return true;
      }
      if (acceptable_type=="string") {
        if(validate_string(value, allowed_values))
          return true;
      }
      if (acceptable_type=="integer") {
        var numeric_val = +value;
        if(numeric_val!=parseInt(numeric_val,10))
          return false;

        if(validate_number(value, allowed_values))
          return true;
      }
      if (acceptable_type=="float") {
        if(validate_number(value, allowed_values))
          return true;
      }
      if (acceptable_type=="boolean") {
        return true;
      }
      return false;
    }

  var validate_number = function(value, allowed_values){
    var numeric_val = +value;

    if(!numeric_val)
      return false;

    if(allowed_values == "")
      return true;

    var allowed_set = allowed_values.split(/\s*[\s,]\s*/)
    for (var i in allowed_set) {
      if( !(+allowed_set[i]) ){
        if(test_number_range(value, allowed_set[i]))
          return true;
      }
      else if (value == +allowed_set[i]) {
        return true;
      }
    }

    return false;
  }

  var test_number_range = function(value, range){
    var nums = range.split(/\s*[\s:]\s*/)
    var lower_limit = +nums[0]
    if(nums[1]!=""){
      var upper_limit = +nums[1]
      if(value >= lower_limit && value<=upper_limit){
        return true;
      }
    }
    else {
      if(value>=lower_limit){
        return true;
      }
    }
    return false;
  }

  var validate_string = function(value, allowed_values){
    if(allowed_values=="")
      return true;

    var allowed_set = allowed_values.split(/\s*[\s,]\s*/)
    for (var i in allowed_set) {
      if (value == allowed_set[i]) {
        return true;
      }
    }
    return false;
  }

    $.extend(
      Validator,
      {validateAll: validate_all},
      {validateSingleInput: validateSingleInput})

  })();

  $(".save_button").on('click',function(event){
    Validator.validateAll($(this).attr('id'), event);
  });

  $(".new_custom_value_input").blur( function(){
      Validator.validateSingleInput($(this));
  });  

  function set_modal(button_id)
  {
    var bnt = document.getElementById(button_id);
    bnt.setAttribute("data-toggle", "modal");

    there_is_static = check_static_parameter_changed();
    if (there_is_static)
    {
      bnt.setAttribute("data-target", "#change_parameter_modal");
    }
    else
    {
      if(btn.getAttribute("name")=="retry_button")
        bnt.setAttribute("data-target", "#retry_save_changes");
      else
        bnt.setAttribute("data-target", "#save_changes");
    }
  }

  jQuery(document).ready(function($) {

    $("#id_change_parameter_yes").keyup(function() {
      btn = document.getElementById("id_change_parameter_btn_modal");
      btn.disabled = $(this).val() != "yes";
      if (btn.disabled) {
        btn.className = 'btn';
      } else {
        btn.className = 'btn btn-primary';
      }
    });
    $("#id_change_parameter_yes").keyup();

  })

function check_static_parameter_changed()
{
  var inputs = document.getElementsByTagName("input");
  var new_value;
  for (x = 0 ; x < inputs.length ; x++){
    myname = inputs[x].getAttribute("name");

    if(myname.indexOf("new_value_")==0){
      new_value = document.getElementById(myname);
      if (new_value.value != "") {
        id = myname.split("new_value_")[1];
        dynamic = document.getElementById("dynamic_"+id);
        if (dynamic.value == "False") {
          return true;
        }
      }
    }

    if(myname.indexOf("reset_default_value_")==0){
      new_value = document.getElementById(myname);
      if (new_value.value != "False") {
        id = myname.split("reset_default_value_")[1];
        dynamic = document.getElementById("dynamic_"+id);
        if (dynamic.value == "False") {
          return true;
        }
      }
    }

  }
  return false;
}


</script>

{% endblock %}
